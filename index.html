<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
    body {
    background: url('/assets/IMG_2083.jpg') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
}

      #dateRange {
        display: block;
        margin: 30vh auto 40px auto;
        width: 85vw;
        max-width: 400px;
        padding: 24px;
        font-size: 22px;
        font-weight: 600;
        text-align: center;
        color: #444;
        background-color: #ffffff;
        border: none;
        border-radius: 999px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
        transition: transform 0.25s ease, box-shadow 0.3s ease;
      }

      #dateRange:hover,
      #dateRange:focus {
        transform: scale(1.03);
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.2);
        background-color: #f8f8f8;
      }



      #summary {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 24px;
        max-width: 92vw;
        margin: 24px auto;
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        text-align: left;
        font-size: 16px;
        line-height: 1.6;
      }

      #summary h2 {
        font-size: 22px;
        margin-bottom: 18px;
        font-weight: 600;
        color: #222;
      }

      #summary p {
        font-size: 17px;
        color: #333;
        margin: 12px 0;
      }

      #promoContainer input {
        width: 100%;
        font-size: 16px;
        padding: 12px;
        margin-top: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }

      #request {
        max-width: 92vw;
        margin: 24px auto;
        text-align: left;
      }

      #request label {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 6px;
        display: block;
      }

      #request input {
        width: 100%;
        padding: 12px;
        margin-top: 4px;
        margin-bottom: 16px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }

      #request button {
        width: 100%;
        padding: 14px;
        border-radius: 30px;
        border: none;
        font-size: 18px;
        background-color: #4CAF50;
        color: white;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        transition: background-color 0.3s ease;
      }

      #request button:hover {
        background-color: #43a047;
      }



      .flatpickr-calendar {
        padding: 20px;
        width: 95vw !important;
        max-width: 420px;
        left: 50% !important;
        transform: translateX(-50%) !important;
        border-radius: 14px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        box-sizing: border-box;
      }

      .flatpickr-day {
        font-size: 20px !important;
        line-height: 2 !important;
        padding: 14px 0 !important;
      }

      .flatpickr-current-month {
        font-size: 22px !important;
      }

      .flatpickr-months,
      .flatpickr-weekdays {
        font-size: 18px !important;
      }


      .flatpickr-day.prevMonthDay:not(.flatpickr-disabled),
      .flatpickr-day.nextMonthDay:not(.flatpickr-disabled) {
        color: #DDDDDD !important;
        font-weight: 400 !important;
      }

      #confirmationMessage {
        display: none;
        text-align: center;
        color: white;
        font-size: 18px;
        font-weight: 500;
        margin-top: 30px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.7);
      }

      .fade-blur-out {
        opacity: 0;
        filter: blur(10px);
        transition: opacity 0.7s ease, filter 0.7s ease;
      }

      #confirmationText {
        font-family: 'Brush Script MT', cursive;
        font-size: 36px;
        animation: typing 2.5s steps(40, end), blink 0.8s step-end infinite;
        white-space: nowrap;
        overflow: hidden;
        border-right: 2px solid white;
        max-width: 100%;
        display: inline-block;
      }

      @keyframes typing {
        from { width: 0 }
        to { width: 100% }
      }

      @keyframes blink {
        50% { border-color: transparent }
      }
    </style>
  </head>
  <body>

<!-- Password Overlay (still commented out) -->
<!-- 
<div id="passwordOverlay"> 
  <div id="passwordBox">
    <p>Do you know the secret password?</p>
    <input type="text" id="passwordInput" placeholder="Enter password" inputmode="numeric" autocomplete="off" style="-webkit-text-security: disc;" />
    <button onclick="verifyPassword()">Submit</button>
    <p id="errorMessage" style="color: red; display: none;">Incorrect password. Please try again.</p>
  </div>
</div>
-->

<input id="dateRange" type="text" placeholder="Availability" autocomplete="off" readonly />

<div id="summary" style="display: none;">
  <p id="details"></p>
  <div id="promoContainer" style="display: none;">
    <input id="promo" type="text" placeholder="enter friends & family secret code" oninput="updateSummary(document.getElementById('dateRange')._flatpickr.selectedDates)" />
  </div>
  <p id="total"></p>

  <h3 style="text-align: center; margin-top: 30px;">To request your stay, please fill in the details below:</h3>
  <div id="request">
    <label>Your Name:<br><input id="guestName" type="text" required></label>
    <label>Your Email:<br><input id="guestEmail" type="email" required></label>
    <label>Your Phone Number:<br><input id="guestPhone" type="text" required></label>
    <button onclick="sendRequest()">Send Request</button>
    <footer style="font-size: 9px; color: gray; text-align: center; margin-top: 20px;">
      Private use only — by invitation of friends & family. Contributions are not payments for lodging, but help cover cleaning and upkeep costs of this shared home.
    </footer>
  </div>
</div>
<div id="confirmationMessage">
  <h1 id="confirmationText" class="typewriter">Request sent! I’ll be in touch soon 🌿</h1>
  <p style="font-size: 14px; color: #e0e0e0; margin-top: 12px;">
    (please check your spam folder)
  </p>
</div>

<div id="loadingMessage" style="
  display: none;
  text-align: center;
  font-size: 16px;
  margin-top: 30px;
  color: white;
  font-weight: bold;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
"></div>

<script>
let availableDates = [];

fetch('https://script.google.com/macros/s/AKfycbz7JwasPrxOnuEfz7ouNfve2KAoueOpmefuEUYnbCsYLE2TfD2zX5CBzvHdQgSEyQp7-g/exec?action=getAvailability')
  .then(response => response.json())
  .then(data => {
    availableDates = data;
    initCalendar();
  })
  .catch(error => {
    console.error("⚠️ Error fetching availability:", error);
  });

let promoCodes = [];

google.script.run.withSuccessHandler(data => {
  promoCodes = data;
}).getPromoCodes();

function initCalendar() {
  const enabledDates = availableDates.map(d => d.date);
  const rateMap = Object.fromEntries(availableDates.map(d => [d.date, d.rate]));

  flatpickr("#dateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    enable: enabledDates,
    defaultDate: new Date(),
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      const dateStr = dayElem.dateObj.toISOString().split('T')[0];
      if (rateMap[dateStr]) {
        const priceTag = document.createElement("span");
        priceTag.innerText = `$${rateMap[dateStr]}`;
        priceTag.style.fontSize = "9px";
        priceTag.style.lineHeight = "1";
        priceTag.style.color = "#555";
        priceTag.style.fontWeight = "500";
        dayElem.appendChild(priceTag);
      }
    },
    onChange: function(selectedDates) {
      if (selectedDates.length === 2) {
        updateSummary(selectedDates);
        document.getElementById("dateRange").value = "Browse Availability";
      }
    }
  });
}

function updateSummary(datesFromPicker = null) {
  const currentPromo = document.getElementById("promo") ? document.getElementById("promo").value.trim() : "";
  let input = document.getElementById("dateRange")._flatpickr.selectedDates;
  if (datesFromPicker) input = datesFromPicker;
  if (input.length < 2) return;

  let [start, end] = input;
  let nights = [];

  for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
    nights.push(d.toISOString().split('T')[0]);
  }

  if (nights.length < 2) {
    document.getElementById("details").innerHTML = `<p style="color: red; font-weight: bold;">There is a 2 night minimum stay.</p>`;
    document.getElementById("total").innerHTML = "";
    document.getElementById("summary").style.display = "block";
    document.getElementById("request").style.display = "block";
    return;
  }

  const rateMap = Object.fromEntries(availableDates.map(d => [d.date, d.rate]));
  let subtotal = nights.reduce((sum, date) => sum + (rateMap[date] || 0), 0);
  let discount = 0;

  if (currentPromo !== "" && promoCodes.length > 0) {
    const code = currentPromo.toUpperCase();
    const bookingDate = start;
    const matches = promoCodes.filter(p => {
      const validStart = !p.start || bookingDate.getTime() >= p.start;
      const validEnd = !p.end || bookingDate.getTime() <= p.end;
      return p.code === code && validStart && validEnd;
    });

    if (matches.length > 0) {
      let maxSavings = 0;
      matches.forEach(p => {
        let currentDiscount = p.type === "%" ? subtotal * (p.amount / 100) : p.amount;
        if (currentDiscount > maxSavings) maxSavings = currentDiscount;
      });
      discount = maxSavings;
    }
  }

  let total = subtotal - discount + 200;
  const checkIn = formatPrettyDate(start);
  const checkOut = formatPrettyDate(end);

  document.getElementById("details").innerHTML = `
    <div style="font-size: 9px; color: gray; text-align: center; margin-top: 20px;">
      This is not a rental, but a private friends & family home. Any contributions help offset upkeep and cleaning costs so we can continue sharing this special place with our circle who we love so much!
    </div> 
    <h2> Visit Details </h2>
    Arrive: ${checkIn}<br>
    Depart: ${checkOut}<br><br>
    Total Nights: ${nights.length}<br>
    Suggested Contribution: $${subtotal.toFixed(2)}<br>
    Cleaning Share: $200<br>
    ${discount > 0 ? `Because we appreciate you: -$${discount.toFixed(2)}<br><br>` : '' }
    <br><br>
    <strong>Suggested Total Contribution: $${total.toFixed(2)}</strong>
  `;

  document.getElementById("promoContainer").style.display = "block";
  document.getElementById("summary").style.display = "block";
  document.getElementById("request").style.display = "block";
}

function formatPrettyDate(d) {
  return d.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function sendRequest() {
  const name = document.getElementById("guestName").value.trim();
  const email = document.getElementById("guestEmail").value.trim();
  const phone = document.getElementById("guestPhone").value.trim();
  const input = document.getElementById("dateRange")._flatpickr.selectedDates;
  const promoInput = document.getElementById("promo").value.trim();

  if (!name || !email || !phone || input.length < 2) {
    alert("Please complete all fields and select your dates.");
    return;
  }

  const [start, end] = input;
  const formData = new URLSearchParams();
  formData.append('name', name);
  formData.append('email', email);
  formData.append('phone', phone);
  formData.append('startDate', start.toISOString().split("T")[0]);
  formData.append('endDate', end.toISOString().split("T")[0]);
  formData.append('promo', promoInput);

  document.getElementById("loadingMessage").style.display = "block";
  document.getElementById("request").style.display = "none";

  fetch('https://script.google.com/macros/s/AKfycbz7JwasPrxOnuEfz7ouNfve2KAoueOpmefuEUYnbCsYLE2TfD2zX5CBzvHdQgSEyQp7-g/exec', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: formData
  })
  .then(response => response.text())
  .then(result => {
    if (result === 'Booking Saved') {
      const requestEl = document.getElementById("request");
      const summaryEl = document.getElementById("summary");
      document.getElementById("loadingMessage").style.display = "none";
      requestEl.classList.add("fade-blur-out");
      summaryEl.classList.add("fade-blur-out");

      setTimeout(() => {
        requestEl.style.display = "none";
        summaryEl.style.display = "none";
        const confirmationEl = document.getElementById("confirmationMessage");
        confirmationEl.style.opacity = "0";
        confirmationEl.style.display = "block";
        setTimeout(() => {
          confirmationEl.style.transition = "opacity 0.7s ease";
          confirmationEl.style.opacity = "1";
        }, 50);
      }, 700);
    } else {
      alert("Something went wrong: " + result);
    }
  });
}
</script>

<!-- Optional: password logic remains commented -->
<script>
/*
function verifyPassword() {
  var password = document.getElementById('passwordInput').value;
  fetch('https://script.google.com/macros/s/AKfycbz7JwasPrxOnuEfz7ouNfve2KAoueOpmefuEUYnbCsYLE2TfD2zX5CBzvHdQgSEyQp7-g/exec', {
    method: 'POST',
    body: new URLSearchParams({ 
      mode: 'password',
      password: password 
    })
  })
  .then(response => response.text())
  .then(result => {
    if (result === 'success') {
      const overlay = document.getElementById('passwordOverlay');
      const box = document.getElementById('passwordBox');
      box.style.display = 'none';
      overlay.classList.add('fade-out');
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 1000);
    } else {
      document.getElementById('errorMessage').style.display = 'block';
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
}
*/
</script>

</body>
</html>
